{% extends "layout.html" %}
{% block content %}
<div class="row">
  <!-- LEFT COLUMN: Betting Events -->
  <div class="col-md-8">

    <!-- Fun Rules of Betting -->
    <div class="card mb-4 border-primary shadow-sm">
      <div class="card-header bg-primary text-white fw-bold">
        ğŸ“œ Rules of Betting â€“ Read Before You Wager!
      </div>
      <div class="card-body">
        <ol>
          <li><strong>It's All for Fun ğŸ‰</strong> â€“ Just for friends and entertainment.</li>
          <li><strong>Start With 1000 Credits ğŸ’°</strong> â€“ Use wisely.</li>
          <li><strong>Check the Odds ğŸ²</strong> â€“ Higher odds = bigger payouts.</li>
          <li><strong>Unlimited Outcomes ğŸ”„</strong> â€“ Choose wisely.</li>
          <li><strong>Bet Responsibly ğŸ¯</strong> â€“ Avoid one crazy hunch unless you like drama.</li>
          <li><strong>Pending Bets â³</strong> â€“ Resolved by admin.</li>
          <li><strong>Winnings ğŸš€</strong> â€“ Stake Ã— odds added to your balance.</li>
          <li><strong>Respect the Admin ğŸ‘‘</strong> â€“ Final decisions.</li>
          <li><strong>Have Fun! ğŸŠ</strong> â€“ Bet smart and laugh loud!</li>
        </ol>
        <p class="text-muted"><em>Disclaimer: All betting here is fictional â€“ no actual money changes hands.</em></p>
      </div>
    </div>

    <!-- Title and slogan -->
    <h1 class="mb-2">ğŸ† Who's Gonna Win? <small class="text-muted">Place your bets now!</small></h1>
    <p class="fs-5 fst-italic text-primary slogan">{{ slogan }}</p>

    <!-- Active Events -->
    <h2 class="mt-4">âœ… Active Events</h2>
    {% if events_data %}
        {% for e in events_data %}
          <div class="card mb-3">
            <div class="card-body">
              <h5>{{ e.event.title }}</h5>
              
              <!-- Betting Form -->
              <form method="POST" action="{{ url_for('place_bet', event_id=e.event.id) }}" class="row g-2">
                  <div class="col-md-4">
                      <select name="outcome_id" class="form-select">
                          {% for o in e.outcomes %}
                              <option value="{{o.id}}">{{o.outcome_name}} @ {{o.odds}}</option>
                          {% endfor %}
                      </select>
                  </div>
                  <div class="col-md-3">
                      <input type="number" name="amount" class="form-control" placeholder="Amount" min="1" required>
                  </div>
                  <div class="col-md-3">
                      <button type="submit" class="btn btn-primary">Place Bet</button>
                  </div>
              </form>

              <!-- Bets Table -->
              {% if e.bets %}
              <div class="mt-3">
                  <h6>ğŸ“‹ Current Bets:</h6>
                  <table class="table table-sm table-bordered">
                      <thead>
                          <tr><th>Player</th><th>Outcome</th><th>Amount</th></tr>
                      </thead>
                      <tbody>
                          {% for bet in e.bets %}
                          <tr>
                              <td>
                                  {{ bet.username }}
                                  {% if bet.is_admin %}
                                      <span class="badge bg-danger">Admin</span>
                                  {% endif %}
                              </td>
                              <td>{{ bet.outcome_name }}</td>
                              <td>{{ bet.amount }}</td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
              {% else %}
              <p class="text-muted mt-2">No bets placed yet for this event.</p>
              {% endif %}

              <!-- Chat Preview -->
              {% if e.chat_preview and e.chat_preview|length > 0 %}
              <div class="mt-3">
                  <h6>ğŸ’¬ Recent Discussion:</h6>
                  <ul class="list-group list-group-flush">
                      {% for msg in e.chat_preview %}
                      <li class="list-group-item">
                          <small>
                              <strong>{{ msg.username }}</strong>
                              {% if msg.is_admin %}
                                  <span class="badge bg-danger">Admin</span>
                              {% endif %}
                              : {{ msg.message }}
                              <span class="text-muted" style="font-size:0.8em;">({{ msg.timestamp }})</span>
                          </small>
                      </li>
                      {% endfor %}
                  </ul>
              </div>
              {% endif %}

              <!-- Discuss Event Button -->
              <a href="{{ url_for('event_chat', event_id=e.event.id) }}" class="btn btn-sm btn-outline-secondary mt-2">
                  ğŸ’¬ Discuss Event
              </a>
            </div>
          </div>
        {% endfor %}
    {% else %}
    <p>No active events</p>
    {% endif %}

    <!-- Pending Events -->
    <h2 class="mt-4">â³ Pending Events</h2>
    {% if pending_events_data %}
        {% for e in pending_events_data %}
          <div class="card mb-3 border-warning">
            <div class="card-body">
              <h5>
                {{ e.event.title }}
                <span class="badge bg-warning text-dark">ğŸ’¡ Suggested</span>
              </h5>
              <ul>
                  {% for o in e.outcomes %}
                      <li>{{ o.outcome_name }} @ {{ o.odds }}</li>
                  {% endfor %}
              </ul>
              <p class="text-muted fst-italic">Awaiting admin approval â€” bets not yet open.</p>
            </div>
          </div>
        {% endfor %}
    {% else %}
    <p>No pending submissions</p>
    {% endif %}

  </div>

  <!-- RIGHT COLUMN: Confessions -->
  <div class="col-md-4">
    <h2>ğŸ™Š Anonymous Confessions</h2>
      <p class="text-muted"><em>Even developers can't see who posted! ğŸ”’</em></p>


    {% if session.user_id %}
      <a href="{{ url_for('add_confession') }}" class="btn btn-warning mb-3">Submit New Confession</a>
    {% else %}
      <p class="text-muted">Log in to submit a confession.</p>
    {% endif %}

    <div class="list-group">
        {% for c in confessions %}
        <div class="list-group-item">
            <p class="mb-1">{{ c.content }}</p>
            <small class="text-muted">{{ c.timestamp }}</small>
        </div>
        {% endfor %}
    </div>
  </div>
</div>
{% endblock %}